% pdflatex paper.tex
% biber paper.bcf
% pdflate paper.tex (x2)

\documentclass[twoside]{article}

\usepackage[sc]{mathpazo}
\usepackage[utf8]{inputenc}
\usepackage[english,italian]{babel}
\linespread{1.05} % Line spacing - Palatino needs more space between lines
\usepackage{microtype} % Slightly tweak font spacing for aesthetics

\usepackage{graphicx}
\usepackage[hmarginratio=1:1,top=32mm,columnsep=20pt, margin=2.5cm]{geometry} % Document margins
%\usepackage{multicol} % Used for the two-column layout of the document
\usepackage[hang, small,labelfont=bf,up,textfont=it,up]{caption} % Custom captions under/above floats in tables or figures
\usepackage{booktabs} % Horizontal rules in tables
\usepackage{float} % Required for tables and figures in the multi-column environment - they need to be placed in specific locations with the [H] (e.g. \begin{table}[H])
\usepackage{hyperref} % For hyperlinks in the PDF
\usepackage{listings}

\usepackage{lettrine} % The lettrine is the first enlarged letter at the beginning of the text
\usepackage{paralist} % Used for the compactitem environment which makes bullet points with less space between them

\usepackage{geometry} % Impostazioni margini
\geometry{a4paper,top=3cm,bottom=3cm,left=1.5cm,right=1.5cm,%
    heightrounded,bindingoffset=5mm}
    
\usepackage{textcomp} % Impostazioni codici
\usepackage[T1]{fontenc}
\lstset{
  basicstyle=\ttfamily,
  columns=flexible,
  upquote,
}

\usepackage{abstract} % Allows abstract customization
\renewcommand{\abstractnamefont}{\normalfont\bfseries} % Set the "Abstract" text to bold
\renewcommand{\abstracttextfont}{\normalfont\small\itshape} % Set the abstract itself to small italic text

\usepackage{titlesec} % Allows customization of titles
\renewcommand\thesection{\Roman{section}} % Roman numerals for the sections
\renewcommand\thesubsection{\Roman{subsection}} % Roman numerals for subsections
\titleformat{\section}[block]{\large\scshape\centering}{\thesection.}{1em}{} % Change the look of the section titles
\titleformat{\subsection}[block]{\large}{\thesubsection.}{1em}{} % Change the look of the section titles
%\usepackage{fancyhdr} % Headers and footers
%\pagestyle{fancy} % All pages have headers and footers
%\fancyhead{} % Blank out the default header
%\fancyfoot{} % Blank out the default footer
%\fancyhead[C]{$\bullet$ Gennaio 2016 $\bullet$} % Custom header text
%\fancyfoot[RO,LE]{\thepage} % Custom footer text

\usepackage{amsmath}
\usepackage{txfonts}
\usepackage{enumitem}

\usepackage{subcaption}

\usepackage{biblatex}
\bibliography{bibliography}

\setlength\parindent{0pt} % Nessuna rientranza ad inizio paragrafo
\setlength\parskip{10pt} % Spaziatura tra paragrafi

%----------------------------------------------------------------------------------------
% IMPOSTAZIONI DI SILLABAZIONE
%----------------------------------------------------------------------------------------

\hyphenation{dynamo baseball cluster consistency COPS replication availability partition-tolerance Communications SIGOPS annual preserving performance}
% Inserire le parole che non devono essere sillabate e spezzate da tex

%----------------------------------------------------------------------------------------
%	CUSTOM MACRO
%----------------------------------------------------------------------------------------

\newcommand{\vclock}{\mathrm{VC}} % VC

%----------------------------------------------------------------------------------------
%	TITLE SECTION
%----------------------------------------------------------------------------------------

\title{\vspace{-15mm}\fontsize{24pt}{10pt}\selectfont\textbf{Configurazione di application server in ambiente di cloud computing}} % Article title

\author{
\large
\textsc{Bartolomeo Lombardi, Amerigo Mancino, Andrea Segalini}\\[2mm] % Your name
\normalsize Università degli Studi di Bologna % Your institution
\vspace{5mm} \\
\normalsize \href{mailto:bartolomeo.lombardi@studio.unibo.it}{bartolomeo.lombardi@studio.unibo.it}\\
\normalsize \href{mailto:amerigo.mancino@studio.unibo.it}{amerigo.mancino@studio.unibo.it}\\
\normalsize \href{mailto:andrea.segalini@studio.unibo.it}{andrea.segalini@studio.unibo.it}
\vspace{-5mm}
}
\date{Anno Accademico 2015-16}

%----------------------------------------------------------------------------------------

\begin{document}
\maketitle 
%\thispagestyle{fancy} % All pages have headers and footers

%----------------------------------------------------------------------------------------
%	ABSTRACT
%----------------------------------------------------------------------------------------

\begin{abstract}
\noindent
OpenNebula è un toolkit che offre una soluzione semplice ma flessibile per la costruzione e la gestione
di soluzioni cloud e di centri di elaborazione dati distribuiti eterogenei.
In questa breve relazione ci proponiamo di illustrare, passo per passo, il lavoro fatto, consistente
nell'installazione e nella configurazione dei software OpenNebula e JBoss, oltre che nella scrittura
di un piccolo programma JBoss volto a dimostrare le proprietà di tolleranza ai guasti e migrazione.
Verranno poi discusse le varie problematiche incontrate e saranno mostrati i metodi che hanno portato
alla loro risoluzione.
\end{abstract}

%----------------------------------------------------------------------------------------

\vspace{15mm} % Spaziatura tra abstract e corpo articolo %% backup {20mm}

%----------------------------------------------------------------------------------------
%	ARTICLE CONTENTS
%----------------------------------------------------------------------------------------



\section{Introduzione: tecnologie utilizzate}
Per creare un sistema di cloud e dimostrare quindi le proprietà di migrazione e
tolleranza ai guasti volute ci si è serviti di due tecnologie principali:
\begin{itemize}
	\item OpenNebula \\
		  Progetto open source per sistemi GNU/Linux supportato da una vasta community, in grado di
		  creare e gestire strutture cloud e data center virtualizzati. Differentemente da altre soluzioni,
		  OpenNebula si pone come un sistema aperto, flessibile e personalizzabile in base alle esigenze
		  oltre che robusto, in grado di fornire anche funzionalità innovative per cloud privati e ibridi.
		  Inoltre permette la realizzazione di cloud Iaas (Infrastructure as a Service), permettendo integrità
		  anche nel caso di macchine eterogenee dal punto di vista hardware e software. Come unico requisito
		  richiede un hardware con supporto per la virtualizzazione.
	\item JBoss \\
		  WildFly, precedentemente noto come JBoss, è un application server open source che implementa
		  le specifiche Java EE. Fra le numerose componenti di cui è costituito il prodotto, sottolineiamo
		  le funzionalità di clustering (che funge da load balancer), di failover (invio di componenti di
		  un sistema ad una seconda componente quando la prima presenta qualche problema), di distributed
		  caching, oltre che di implementazione distribuita. Tutte queste caratteristiche la rendono una
		  ottima piattaforma di sviluppo.
\end{itemize}

\section{Configurazione di OpenNebula}
L'installazione di OpenNebula avviene in maniera differente a seconda del ruolo giocato dal componente.
Si distingue il Front-end, ossia colui che esegue OpenNebula, instanzia le macchine virtuali sugli altri
membri e gestisce di fatto l'intera rete cloud, e i Worker, i quali eseguono invece la macchine virtuali
instanziate dal Front-end.

Per stabilire la comunicazione fra Front-end e Worker è stato usato un router e sono stati impostati
gli indirizzi IP staticamente. Il Front-end è stato installato su sistema Ubuntu 14.04 ed è stata seguita
la procedura di installazione illustrata nella documentazione ufficiale di OpenNebula (\cite{bib:baseball}).
I comandi preceduti da \# sono da considerare eseguiti da utente root, il cui passaggio è consentito
mediante il comando:
\begin{lstlisting}[frame=trBL]
sudo su
\end{lstlisting}
mentre quelli preceduti da \$ vanno intesi eseguiti da oneadmin, creato durante l'installazione del
repository.

\section{Configurazione di OpenNebula su Front-end}
In primo luogo abbiamo verificato il supporto alla virtualizzazione eseguendo il comando:
\begin{lstlisting}[frame=trBL]
grep -E 'svm|vmx' /proc/cpuinfo
\end{lstlisting}

Successivamente ci siamo curati di aggiungere il repository di OpenNebula:
\begin{lstlisting}[frame=trBL]
# wget -q -O- http://downloads.opennebula.org/repo/Ubuntu/repo.key | apt-key add -
# echo "deb http://downloads.opennebula.org/repo/4.12/Ubuntu/14.04/ stable 
  opennebula" \ > /etc/apt/sources.list.d/opennebula.list
\end{lstlisting}

E dell'installazione dei pacchetti necessari:
\begin{lstlisting}[frame=trBL]
# apt-get update
# apt-get install opennebula opennebula-sunstone nfs-kernel-server
\end{lstlisting}

A questo punto è stata configurata la Sunstone, ossia l'interfaccia grafica di OpenNebula,
e ciò è stato fatto modificando il file 
\texttt{/etc/one/sunstone-server.conf}, sostituendo la riga \texttt{:host:} \texttt{127.0.0.1}
con la riga \texttt{:host:} \texttt{0.0.0.0} e successivamente viene fatto il restart del servizio:
\begin{lstlisting}[frame=trBL]
# /etc/init.d/opennebula-sunstone restart
\end{lstlisting}

Dal momento che abbiamo usato delle macchine differenti nei nostri esperimenti, abbiamo optato
per la configurazione di un network file system distribuito: è stato necessario dunque esportare
\texttt{/var/lib/one/} dal front-end ai nodi worker, e aggiungere al file \texttt{/etc/exports}
del front-end la riga:
\begin{lstlisting}[frame=trBL]
/var/lib/one/ *(rw,sync,no_subtree_check,root_squash)
\end{lstlisting}

Infine abbiamo fatto ripartire il servizio:
\begin{lstlisting}[frame=trBL]
# service nfs-kernel-server restart
\end{lstlisting}

OpenNebula ha bisogno poi di una chiave SSH senza password da ogni nodo (incluso il front-end)
verso ogni altro nodo. Per far ciò, abbiamo eseguito i seguenti comandi:
\begin{lstlisting}[frame=trBL]
# su - oneadmin
$ cp ~/.ssh/id_rsa.pub ~/.ssh/authorized_key
\end{lstlisting}

E poi abbiamo aggiunto il seguente frammento al file \texttt{~/.ssh/config}:
\begin{lstlisting}[frame=trBL]
$ cat << EOT > ~/.ssh/config
Host *
    StrictHostKeyChecking no
    UserKnownHostsFile /dev/null
EOT
$ chmod 600 ~/.ssh/config
\end{lstlisting}

\section{Configurazione di OpenNebula su nodi Worker}
I worker sono i nodi su cui vengono eseguite le macchine virtuali instanziate dal front-end.
La configurazione è simile a quella eseguita fatta sul front-end: è stata scaricata la repo
e installate tutte le dipendenze. Successivamente abbiamo scelto di usare il protocollo DHCP
attraverso l'interfaccia eth0 e di utilizzare IP statici, come già detto, andando a sostituire
quindi il file \texttt{/etc/network/interfaces} con:
\begin{lstlisting}[frame=trBL]
auto lo
iface lo inet loopback

auto br0
iface br0 inet static
        address 192.168.1.101 // indirizzo del worker
        network 192.168.1.0
        netmask 255.255.255.0
        broadcast 192.168.0.255
        gateway 192.168.0.1
        bridge_ports eth0
        bridge_fd 9
        bridge_hello 2
        bridge_maxage 12
        bridge_stp off
\end{lstlisting}

Dopo aver fatto questi cambiamenti, abbiamo fatto ripartire il servizio:
\begin{lstlisting}[frame=trBL]
# /etc/init.d/networking restart
\end{lstlisting}

Poi abbiamo aggiunto al file \texttt{/etc/fstab} la riga:
\begin{lstlisting}[frame=trBL]
192.168.1.100:/var/lib/one/  /var/lib/one/  nfs   soft,intr,rsize=8192,wsize=8192,noauto
\end{lstlisting}

Dove \texttt{192.168.1.100} è l'indirizzo IP del front-end. Infine è bastato eseguire:
\begin{lstlisting}[frame=trBL]
# mount /var/lib/one/
\end{lstlisting}

Poi abbiamo configurato Qemu, l'interfaccia per permettere la simulazione delle macchine virtuali:
\begin{lstlisting}[frame=trBL]
# cat << EOT > /etc/libvirt/qemu.conf
user  = "oneadmin"
group = "oneadmin"
dynamic_ownership = 0
EOT
\end{lstlisting}

Per rendere effettivi i cambiamenti abbiamo fatto ripartire libvirt:
\begin{lstlisting}[frame=trBL]
# service libvirt-bin restart
\end{lstlisting}

Quando abbiamo provato a far comunicare il front-end con un worker attraverso il router
mediante un comando di ping la prima volta, inspiegabilmente abbiamo ottenuto un fallimento. Questo
era dovuto alla presenza di un firewall installato sul front-end che è stato, dunque, disabilitato
permettendo alle due macchine di vedersi.

\section{Preparazione dell'ambiente}
Come accennato in precedenza, ogni operazione in OpenNebula può essere fatta mediante
il terminale a riga di comando oppure utilizzando l'apposita interfaccia grafica Sunstone. Nelle nostre
prove abbiamo optato per la seconda opzione. Per accedere dunque alla Sunstone è sufficiente far puntare il
browser web (del front-end chiaramente) all'indirizzo \texttt{http://localhost:9869}.

A questo punto, è stato necessario preparare le immagini da inserire nel template della virtual machine.
Abbiamo quindi scaricato Ubuntu Server 14.04.3 LTS e dal front-end abbiamo eseguito:
\begin{lstlisting}[frame=trBL]
$ qemu-img create -f qcow2 disk_image.img 5G
$ kvm -cpu host -smp 1 -m 1024 disk_image.img
\end{lstlisting}

Il sistema è stato impreziosito con:
\begin{itemize}
	\item installazione SSH
\end{itemize}
\begin{lstlisting}[frame=trBL]
# apt-get install openssh-client openssh-server
\end{lstlisting}
\begin{itemize}
\item installazione di JBoss
\end{itemize}		  
\begin{lstlisting}[frame=trBL]
$ wget http://download.jboss.org/jbossas/7.1/jboss-as-7.1.1.Final/jboss-as-7.1.1.Final.tar.gz		  
\end{lstlisting}

\printbibliography

\end{document}
